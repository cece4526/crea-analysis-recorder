<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard C√©r√©ales - CR√âA Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/build/app.css" rel="stylesheet">
    <link href="/build/dashboard.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid mt-3">
        <h1 class="text-center text-primary mb-4">üìä Dashboard de Production - C√©r√©ales</h1>
        
        <div class="row">
            <!-- OF 1 -->
            <div class="col-md-6">
                {% if of1 %}
                <div class="of-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3>üåæ OF {{ of1.numero }}</h3>
                            <p class="mb-0">
                                <span class="status-indicator status-{{ of1.statut }}"></span>
                                Statut: {{ of1.statut|upper }}
                            </p>
                            {% if of1.produit %}
                            <p class="mb-0">Produit: {{ of1.produit }}</p>
                            {% endif %}
                            {% if of1.quantite %}
                            <p class="mb-0">Quantit√©: {{ of1.quantite }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="openHaccpModal('{{ of1.numero }}', 'cereales')">
                                <i class="fas fa-shield-alt me-1"></i>HACCP
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="openCuveHydrolyseModal('{{ of1.numero }}', 'cereales')">
                                <i class="fas fa-flask me-1"></i>Cuve Hydrolyse
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="process-card">
                    <h5>üìà Processus de Production</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center p-3 border rounded">
                                <div class="status-indicator status-en-cours"></div>
                                <strong>Cuves C√©r√©ales</strong>
                                <div class="mt-2">
                                    <small class="text-muted">Temp√©rature: 85¬∞C</small><br>
                                    <small class="text-muted">Dur√©e: 45 min</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 border rounded">
                                <div class="status-indicator status-en-attente"></div>
                                <strong>D√©canteur</strong>
                                <div class="mt-2">
                                    <small class="text-muted">En attente</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="process-card">
                    <h5>üî¨ Enzymes & Corrections</h5>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-en-cours"></div>
                                <strong>Enzyme</strong><br>
                                <small>10:30</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-en-attente"></div>
                                <strong>Avant Correct</strong><br>
                                <small>--:--</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-en-attente"></div>
                                <strong>Apr√®s Correct</strong><br>
                                <small>--:--</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="of-header">
                    <h3>üåæ Aucun OF actif</h3>
                    <p class="mb-0">Pas d'ordre de fabrication en cours</p>
                </div>
                {% endif %}
            </div>
            
            <!-- OF 2 -->
            <div class="col-md-6">
                {% if of2 %}
                <div class="of-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3>üåæ OF {{ of2.numero }}</h3>
                            <p class="mb-0">
                                <span class="status-indicator status-{{ of2.statut }}"></span>
                                Statut: {{ of2.statut|upper }}
                            </p>
                            {% if of2.produit %}
                            <p class="mb-0">Produit: {{ of2.produit }}</p>
                            {% endif %}
                            {% if of2.quantite %}
                            <p class="mb-0">Quantit√©: {{ of2.quantite }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="openHaccpModal('{{ of2.numero }}', 'cereales')">
                                <i class="fas fa-shield-alt me-1"></i>HACCP
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="openCuveHydrolyseModal('{{ of2.numero }}', 'cereales')">
                                <i class="fas fa-flask me-1"></i>Cuve Hydrolyse
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="process-card">
                    <h5>üìà Processus de Production</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center p-3 border rounded">
                                <div class="status-indicator status-termine"></div>
                                <strong>Cuves C√©r√©ales</strong>
                                <div class="mt-2">
                                    <small class="text-muted">Termin√©</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 border rounded">
                                <div class="status-indicator status-en-cours"></div>
                                <strong>D√©canteur</strong>
                                <div class="mt-2">
                                    <small class="text-muted">En cours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="process-card">
                    <h5>üî¨ Enzymes & Corrections</h5>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-termine"></div>
                                <strong>Enzyme</strong><br>
                                <small>09:15</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-termine"></div>
                                <strong>Avant Correct</strong><br>
                                <small>10:45</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2 border rounded">
                                <div class="status-indicator status-en-attente"></div>
                                <strong>Apr√®s Correct</strong><br>
                                <small>--:--</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="of-header">
                    <h3>üåæ Slot libre</h3>
                    <p class="mb-0">Pr√™t pour un nouvel OF</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Statistiques -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Statistiques G√©n√©rales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h4 class="text-primary">{{ production_count }}</h4>
                                <p>Productions totales</p>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-success">{{ haccp_count }}</h4>
                                <p>Contr√¥les HACCP</p>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-warning">{{ of1 and of2 ? 2 : (of1 ? 1 : 0) }}</h4>
                                <p>OF actifs</p>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-info">{{ "now"|date("H:i") }}</h4>
                                <p>Heure actuelle</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inclusion des popups -->
    {% include 'partials/haccp_modal.html.twig' %}
    {% include 'partials/cuve_hydrolyse_modal.html.twig' %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/build/runtime.js"></script>
    <script src="/build/app.js"></script>
    
    <script>
    // Script HACCP √† charger apr√®s Bootstrap
    function openHaccpModal(ofId, productionType) {
        console.log('Tentative d\'ouverture de la popup HACCP pour OF:', ofId);
        
        // V√©rifier que l'√©l√©ment existe
        const modalElement = document.getElementById('haccpModal');
        if (!modalElement) {
            console.error('√âl√©ment haccpModal non trouv√©');
            alert('Erreur: Popup HACCP non trouv√©e');
            return;
        }
        
        // Remplir l'ID de l'OF
        const ofIdInput = document.getElementById('haccp_of_id');
        if (ofIdInput) {
            ofIdInput.value = ofId;
        }
        
        // V√©rifier que Bootstrap est charg√©
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap non charg√©');
            alert('Erreur: Bootstrap non charg√©');
            return;
        }
        
        try {
            // Ouvrir la modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } catch (error) {
            console.error('Erreur lors de l\'ouverture de la modal:', error);
            alert('Erreur lors de l\'ouverture de la popup: ' + error.message);
        }
    }
    
    // Gestion de la soumission du formulaire HACCP
    document.addEventListener('DOMContentLoaded', function() {
        const haccpForm = document.getElementById('haccpForm');
        if (haccpForm) {
            // Validation en temps r√©el des valeurs
            function updateStatus() {
                // Contr√¥le temp√©rature COP
                const temperatureCible = parseFloat(document.getElementById('temperature_cible').value) || 110;
                const temperatureIndique = parseFloat(document.getElementById('temperature_indique').value) || 0;
                const statusTemperature = document.getElementById('status_temperature');
                
                if (temperatureIndique >= temperatureCible) {
                    statusTemperature.className = 'bg-success rounded p-2';
                    statusTemperature.style.height = '20px';
                } else if (temperatureIndique > 0) {
                    statusTemperature.className = 'bg-danger rounded p-2';
                    statusTemperature.style.height = '20px';
                } else {
                    statusTemperature.className = 'bg-secondary rounded p-2';
                    statusTemperature.style.height = '20px';
                }
                
                // Contr√¥le filtre pasteurisateur (case √† cocher)
                const filtrePasteurisateur = document.getElementById('filtre_pasteurisateur_resultat').checked;
                const statusFiltrePasteurisateur = document.getElementById('status_filtre_pasteurisateur');
                
                if (filtrePasteurisateur) {
                    statusFiltrePasteurisateur.className = 'bg-success rounded p-2';
                } else {
                    statusFiltrePasteurisateur.className = 'bg-secondary rounded p-2';
                }
                statusFiltrePasteurisateur.style.height = '20px';
                
                // Contr√¥le filtre NEP (case √† cocher)
                const filtreNep = document.getElementById('filtre_nep_resultat').checked;
                const statusFiltreNep = document.getElementById('status_filtre_nep');
                
                if (filtreNep) {
                    statusFiltreNep.className = 'bg-success rounded p-2';
                } else {
                    statusFiltreNep.className = 'bg-secondary rounded p-2';
                }
                statusFiltreNep.style.height = '20px';
            }
            
            // √âcouteurs pour les champs
            document.getElementById('temperature_cible').addEventListener('input', updateStatus);
            document.getElementById('temperature_indique').addEventListener('input', updateStatus);
            document.getElementById('filtre_pasteurisateur_resultat').addEventListener('change', updateStatus);
            document.getElementById('filtre_nep_resultat').addEventListener('change', updateStatus);
            
            haccpForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validation critique pour temp√©rature
                const temperatureCible = parseFloat(document.getElementById('temperature_cible').value) || 110;
                const temperatureIndique = parseFloat(document.getElementById('temperature_indique').value) || 0;
                
                if (temperatureIndique > 0 && temperatureIndique < temperatureCible) {
                    const confirm = window.confirm('‚ö†Ô∏è ATTENTION: La temp√©rature indiqu√©e (' + temperatureIndique + ') est inf√©rieure √† la temp√©rature cible (' + temperatureCible + ').\n\nVoulez-vous quand m√™me enregistrer ce contr√¥le ?');
                    if (!confirm) {
                        return;
                    }
                }
                
                // Envoi AJAX
                const formData = new FormData(this);
                
                fetch('/haccp/create', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Contr√¥les HACCP enregistr√©s avec succ√®s !');
                        
                        // Fermer la modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('haccpModal'));
                        modal.hide();
                        
                        // R√©initialiser le formulaire
                        document.getElementById('haccpForm').reset();
                        updateStatus(); // R√©initialiser les status
                        
                        // Optionnel : recharger la page pour voir les nouveaux donn√©es
                        location.reload();
                    } else {
                        alert('‚ùå ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('‚ùå Erreur de communication avec le serveur');
                });
            });
        }
    });
    
    // Scripts pour la Cuve Hydrolyse
    function openCuveHydrolyseModal(ofNumero, productionType) {
        console.log('Ouverture du modal Cuve Hydrolyse pour OF:', ofNumero);
        
        // V√©rifier que l'√©l√©ment existe
        const modalElement = document.getElementById('cuveHydrolyseModal');
        if (!modalElement) {
            console.error('√âl√©ment cuveHydrolyseModal non trouv√©');
            alert('Erreur: Modal Cuve Hydrolyse non trouv√©');
            return;
        }

        // R√©initialiser le formulaire AVANT de remplir les donn√©es
        document.getElementById('cuveHydrolyseForm').reset();
        
        // Ouvrir le modal
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Attendre que le modal soit compl√®tement affich√© avant de charger les d√©tails
        modalElement.addEventListener('shown.bs.modal', function() {
            console.log('Modal compl√®tement affich√©, chargement des d√©tails...');
            loadOFDetails(ofNumero);
        }, { once: true });
    }

    function loadOFDetails(ofNumero) {
        console.log('Chargement des d√©tails pour OF num√©ro:', ofNumero);
        
        // Mapping des vrais produits de la base de donn√©es
        let ofId = null;
        let ofDescription = '';
        
        if (ofNumero == '76931') {
            ofId = 1;
            ofDescription = 'OF #76931 - C√©r√©ales Bio';
        } else if (ofNumero == '76932') {
            ofId = 2;
            ofDescription = 'OF #76932 - C√©r√©ales Standard';
        } else {
            // Par d√©faut, on utilise l'OF 1
            ofId = 1;
            ofDescription = 'OF #' + ofNumero + ' - C√©r√©ales Bio';
        }
        
        console.log('Mapping OF num√©ro', ofNumero, 'vers ID', ofId);
        
        // Remplir les champs avec les infos de l'OF
        const displayElement = document.getElementById('cuve_of_display');
        const idElement = document.getElementById('cuve_of_id');
        
        if (displayElement) {
            displayElement.value = ofDescription;
            console.log('Champ cuve_of_display trouv√© et rempli avec:', ofDescription);
        } else {
            console.error('√âl√©ment cuve_of_display non trouv√© !');
        }
        
        if (idElement) {
            idElement.value = ofId;
            console.log('Champ cuve_of_id trouv√© et rempli avec:', ofId);
        } else {
            console.error('√âl√©ment cuve_of_id non trouv√© !');
        }
        
        // Mettre √† jour l'info dans le modal
        const ofInfo = document.getElementById('cuveOfInfo');
        if (ofInfo) {
            ofInfo.textContent = ofNumero;
            console.log('√âl√©ment cuveOfInfo trouv√© et rempli avec:', ofNumero);
        } else {
            console.error('√âl√©ment cuveOfInfo non trouv√© !');
        }
        
        console.log('Champs remplis - Display:', ofDescription, 'ID:', ofId);
    }
    
    function submitCuveHydrolyseForm() {
        console.log('Soumission du formulaire Cuve Hydrolyse');
        
        const form = document.getElementById('cuveHydrolyseForm');
        const formData = new FormData(form);
        
        // Validation des champs obligatoires
        const ofId = document.getElementById('cuve_of_id').value;
        const cuveNumero = document.getElementById('cuve_numero').value;
        const debitEnzyme = document.getElementById('cuve_debit_enzyme').value;
        const temperature = document.getElementById('cuve_temperature').value;
        const quantiteEnzyme = document.getElementById('cuve_quantite_enzyme').value;
        const matiere = document.getElementById('cuve_matiere').value;
        const initialPilote = document.getElementById('cuve_initial_pilote').value;
        const controlVerre = document.querySelector('input[name="control_verre"]:checked');
        
        // V√©rification de tous les champs obligatoires
        if (!ofId) {
            alert('‚ö†Ô∏è L\'Ordre de Fabrication est obligatoire');
            return;
        }
        
        if (!cuveNumero) {
            alert('‚ö†Ô∏è Le num√©ro de cuve est obligatoire');
            return;
        }
        
        if (!debitEnzyme) {
            alert('‚ö†Ô∏è Le d√©bit d\'incorporation d\'enzyme est obligatoire');
            return;
        }
        
        if (!temperature) {
            alert('‚ö†Ô∏è La temp√©rature d\'hydrolyse est obligatoire');
            return;
        }
        
        if (!quantiteEnzyme) {
            alert('‚ö†Ô∏è La quantit√© d\'enzyme est obligatoire');
            return;
        }
        
        if (!matiere) {
            alert('‚ö†Ô∏è La mati√®re ajout√©e est obligatoire');
            return;
        }
        
        if (!initialPilote) {
            alert('‚ö†Ô∏è L\'initial pilote est obligatoire');
            return;
        }
        
        if (!controlVerre) {
            alert('‚ö†Ô∏è Le contr√¥le visuel est obligatoire');
            return;
        }
        
        // Convertir les donn√©es du formulaire en objet
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Ajouter la date de cr√©ation
        data['created_at'] = new Date().toISOString();
        
        console.log('=== DEBUG FORMULAIRE CUVE ===');
        console.log('OF ID trouv√©:', ofId);
        console.log('Donn√©es FormData brutes:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        console.log('Objet final √† envoyer:', data);
        console.log('=== FIN DEBUG ===');
        
        // Envoyer les donn√©es
        fetch('/cuve-cereales/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('R√©ponse du serveur:', data);
            if (data.success) {
                alert('‚úÖ ' + data.message);
                
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cuveHydrolyseModal'));
                modal.hide();
                
                // R√©initialiser le formulaire
                document.getElementById('cuveHydrolyseForm').reset();
                
                // Optionnel : recharger la page pour voir les nouveaux donn√©es
                location.reload();
            } else {
                alert('‚ùå ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('‚ùå Erreur de communication avec le serveur');
        });
    }
    </script>
</body>
</html>
